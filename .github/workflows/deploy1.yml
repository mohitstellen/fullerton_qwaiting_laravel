name: Deploy Laravel via SSH

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout code
      uses: actions/checkout@v3

    - name: ‚öôÔ∏è Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, mysql
        tools: composer

    - name: üì¶ Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: üõ†Ô∏è Prepare Laravel storage paths
      run: |
        mkdir -p storage/framework/views
        mkdir -p storage/framework/cache
        mkdir -p storage/logs

    - name: üì¶ Install Dependencies
      run: composer install --prefer-dist --no-progress


    - name: üîç Check SSH Secrets (Safe)
      run: |
        if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "SSH_HOST is EMPTY"; else echo "SSH_HOST is SET"; fi
        if [ -z "${{ secrets.SSH_USER }}" ]; then echo "SSH_USER is EMPTY"; else echo "SSH_USER is SET"; fi
        if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then echo "SSH_PASSWORD is EMPTY"; else echo "SSH_PASSWORD is SET"; fi
        if [ -z "${{ secrets.SSH_PORT }}" ]; then echo "SSH_PORT is EMPTY"; else echo "SSH_PORT is SET"; fi
    - name: üöÄ Deploy via SSH
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd /home/fullertonthevist/public_html
        
          # Git setup
          git config --global user.email "mohitstelleninfotech@gmail.com"
          git config --global user.name "mohitstellen"
          git config pull.rebase false

          git pull origin main

          php artisan migrate --path=database/migrations/2025_11_28_101635_add_company_id_to_categories_table.php --force

          php artisan migrate --path=database/migrations/2025_11_28_111709_add_appointment_email_templates_to_notification_templates_table.php --force

          php artisan migrate --path=database/migrations/2025_11_28_120000_rename_appointment_email_columns_in_notification_templates_table.php --force

          php artisan migrate --path=database/migrations/2025_11_28_151819_add_country_code_and_mobile_length_to_allowed_countries_table.php --force

          php artisan migrate --path=database/migrations/2025_11_28_155045_add_company_id_to_activity_logs_table.php --force

          php artisan migrate --path=database/migrations/2025_11_28_155417_rename_company_id_to_country_id_in_activity_logs_table.php --force

          php artisan migrate --path=database/migrations/2025_11_28_164341_create_member_imports_table.php --force

          php artisan o:clear
          
      