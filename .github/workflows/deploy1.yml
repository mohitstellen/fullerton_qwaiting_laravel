name: Deploy Laravel via SSH

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout code
      uses: actions/checkout@v3

    - name: ‚öôÔ∏è Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, mysql
        tools: composer

    - name: üì¶ Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: üõ†Ô∏è Prepare Laravel storage paths
      run: |
        mkdir -p storage/framework/views
        mkdir -p storage/framework/cache
        mkdir -p storage/logs

    - name: üì¶ Install Dependencies
      run: composer install --prefer-dist --no-progress


    - name: üîç Check SSH Secrets (Safe)
      run: |
        if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "SSH_HOST is EMPTY"; else echo "SSH_HOST is SET"; fi
        if [ -z "${{ secrets.SSH_USER }}" ]; then echo "SSH_USER is EMPTY"; else echo "SSH_USER is SET"; fi
        if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then echo "SSH_PASSWORD is EMPTY"; else echo "SSH_PASSWORD is SET"; fi
        if [ -z "${{ secrets.SSH_PORT }}" ]; then echo "SSH_PORT is EMPTY"; else echo "SSH_PORT is SET"; fi
    - name: üöÄ Deploy via SSH
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd /home/fullertonthevist/public_html
        
          # Git setup
          git config --global user.email "mohitstelleninfotech@gmail.com"
          git config --global user.name "mohitstellen"
          git config pull.rebase false

          git pull origin main

          # Run specific migration
          php artisan migrate --path=database/migrations/2025_12_18_175056_create_vouchers_table.php
          php artisan migrate --path=database/migrations/2025_12_18_180055_add_card_types_to_vouchers_table.php
          php artisan migrate --path=database/migrations/2025_12_18_183644_add_booking_for_to_bookings_table.php
          php artisan migrate --path=database/migrations/2025_12_19_171324_add_phone_remarks_sms_to_locations_table.php
          php artisan migrate --path=database/migrations/2025_12_19_173232_add_created_by_to_companies_table.php
          php artisan migrate --path=database/migrations/2025_12_19_173430_remove_created_by_from_companies_table.php
          php artisan migrate --path=database/migrations/2025_12_19_185031_add_appointment_sms_templates_to_message_templates_table.php
          
          # Clear all caches
          php artisan o:clear
          
         
          
      